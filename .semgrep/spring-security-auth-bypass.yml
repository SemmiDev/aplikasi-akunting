rules:
  - id: spring-security-permitall-on-sensitive-endpoint
    message: >-
      Sensitive endpoint uses permitAll() which allows unauthenticated access.
      This could expose sensitive data or functionality. Ensure this is intentional
      or use authenticated() / hasAuthority() instead.
    severity: WARNING
    metadata:
      category: security
      technology:
        - spring
        - spring-security
      owasp:
        - A01:2021 - Broken Access Control
      cwe:
        - 'CWE-284: Improper Access Control'
      confidence: HIGH
    languages:
      - java
    patterns:
      - pattern-either:
          - pattern: |
              $HTTP.requestMatchers($MATCHER).permitAll()
          - pattern: |
              $HTTP.antMatchers($MATCHER).permitAll()
      - metavariable-regex:
          metavariable: $MATCHER
          regex: .*(admin|user|employee|payroll|transaction|account|report|settings|api).*((?!login|public|health|actuator).)*
    fix: $HTTP.requestMatchers($MATCHER).authenticated()
    paths:
      include:
        - '**/SecurityConfig.java'
        - '**/WebSecurityConfig.java'

  - id: spring-security-missing-preauthorize
    message: >-
      Controller method handles sensitive operations but lacks @PreAuthorize annotation.
      This could allow unauthorized access. Add @PreAuthorize with appropriate permission check.
    severity: WARNING
    metadata:
      category: security
      technology:
        - spring
        - spring-security
      owasp:
        - A01:2021 - Broken Access Control
      cwe:
        - 'CWE-862: Missing Authorization'
      confidence: MEDIUM
    languages:
      - java
    patterns:
      - pattern-either:
          - pattern: |
              @PostMapping(...)
              public $TYPE $METHOD(...) { ... }
          - pattern: |
              @PutMapping(...)
              public $TYPE $METHOD(...) { ... }
          - pattern: |
              @DeleteMapping(...)
              public $TYPE $METHOD(...) { ... }
      - pattern-not-inside: |
          @PreAuthorize(...)
          $X
      - metavariable-regex:
          metavariable: $METHOD
          regex: .*(create|update|delete|post|void|approve|reject|modify|edit|remove).*(User|Transaction|Account|Employee|Payroll|Settings|Permission|Role).*
    paths:
      include:
        - '**/controller/**'

  - id: spring-security-csrf-disabled
    message: >-
      CSRF protection is disabled. This makes the application vulnerable to
      Cross-Site Request Forgery attacks. Only disable CSRF for stateless APIs
      that use token-based authentication.
    severity: ERROR
    metadata:
      category: security
      technology:
        - spring
        - spring-security
      owasp:
        - A01:2021 - Broken Access Control
      cwe:
        - 'CWE-352: Cross-Site Request Forgery (CSRF)'
      confidence: HIGH
    languages:
      - java
    patterns:
      - pattern-either:
          - pattern: $HTTP.csrf().disable()
          - pattern: $HTTP.csrf(csrf -> csrf.disable())
    paths:
      include:
        - '**/SecurityConfig.java'
        - '**/WebSecurityConfig.java'

  - id: spring-security-cors-allow-all-origins
    message: >-
      CORS is configured to allow all origins (*). This could enable
      cross-origin attacks. Explicitly specify allowed origins.
    severity: WARNING
    metadata:
      category: security
      technology:
        - spring
        - spring-security
      owasp:
        - A01:2021 - Broken Access Control
      cwe:
        - 'CWE-942: Permissive Cross-domain Policy with Untrusted Domains'
      confidence: HIGH
    languages:
      - java
    patterns:
      - pattern-either:
          - pattern: $CORS.allowedOrigins("*")
          - pattern: $CORS.allowedOriginPatterns("*")
    fix: $CORS.allowedOrigins("https://yourdomain.com")
    paths:
      include:
        - '**/SecurityConfig.java'
        - '**/WebSecurityConfig.java'
        - '**/CorsConfig.java'

  - id: spring-security-weak-password-encoder
    message: >-
      Using weak or deprecated password encoder. MD5, SHA-1, and plain text
      password encoders are cryptographically broken. Use BCryptPasswordEncoder
      or Argon2PasswordEncoder instead.
    severity: ERROR
    metadata:
      category: security
      technology:
        - spring
        - spring-security
      owasp:
        - A02:2021 - Cryptographic Failures
      cwe:
        - 'CWE-326: Inadequate Encryption Strength'
      confidence: HIGH
    languages:
      - java
    patterns:
      - pattern-either:
          - pattern: new NoOpPasswordEncoder()
          - pattern: new Md5PasswordEncoder()
          - pattern: new Md4PasswordEncoder()
          - pattern: new ShaPasswordEncoder()
          - pattern: new LdapShaPasswordEncoder()
          - pattern: NoOpPasswordEncoder.getInstance()
          - pattern: PasswordEncoderFactories.createDelegatingPasswordEncoder()
    fix: new BCryptPasswordEncoder()
    paths:
      include:
        - '**/SecurityConfig.java'
        - '**/PasswordConfig.java'

  - id: spring-security-hardcoded-credentials
    message: >-
      Hardcoded credentials detected in security configuration. Store credentials
      in environment variables or external configuration.
    severity: ERROR
    metadata:
      category: security
      technology:
        - spring
        - spring-security
      owasp:
        - A07:2021 - Identification and Authentication Failures
      cwe:
        - 'CWE-798: Use of Hard-coded Credentials'
      confidence: HIGH
    languages:
      - java
    patterns:
      - pattern-either:
          - pattern: $USER.password("...")
          - pattern: $AUTH.inMemoryAuthentication()...password("...")
      - metavariable-regex:
          metavariable: $PASSWORD
          regex: (?!.*(\$\{|env\.|System\.getenv)).*
    paths:
      include:
        - '**/SecurityConfig.java'
        - '**/WebSecurityConfig.java'
