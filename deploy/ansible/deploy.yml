---
- name: Deploy Accounting Finance Application
  hosts: accounting
  become: yes

  pre_tasks:
    - name: Validate admin_username is set
      ansible.builtin.fail:
        msg: "admin_username is not set or uses default value"
      when: admin_username is not defined or admin_username == 'CHANGE_THIS_USERNAME'

    - name: Reject common admin usernames (security)
      ansible.builtin.fail:
        msg: "admin_username '{{ admin_username }}' is a common username susceptible to enumeration attacks. Use a unique username."
      when: admin_username | lower in ['admin', 'administrator', 'root', 'superuser', 'sysadmin', 'user', 'test']

    - name: Validate admin_password_plain is set
      ansible.builtin.fail:
        msg: "admin_password_plain is not set or uses default value"
      when: admin_password_plain is not defined or admin_password_plain == 'CHANGE_THIS_ADMIN_PASSWORD'

    - name: Generate bcrypt hash for admin password
      ansible.builtin.set_fact:
        admin_password_bcrypt: "{{ admin_password_plain | password_hash('bcrypt', rounds=10) }}"

  tasks:
    - name: Build application locally
      ansible.builtin.command:
        cmd: ./mvnw clean package -DskipTests
        chdir: "{{ playbook_dir }}/../.."
      delegate_to: localhost
      become: no
      register: build_result

    - name: Find built jar file
      ansible.builtin.find:
        paths: "{{ playbook_dir }}/../../target"
        patterns: "*.jar"
        excludes: "*-sources.jar"
      delegate_to: localhost
      become: no
      register: jar_files

    - name: Fail if jar not found
      ansible.builtin.fail:
        msg: "No jar file found in target directory"
      when: jar_files.files | length == 0

    - name: Stop application
      ansible.builtin.systemd:
        name: "{{ app_name }}"
        state: stopped
      ignore_errors: yes

    - name: Upload Google Cloud credentials (if enabled and file exists locally)
      ansible.builtin.copy:
        src: "{{ google_cloud_credentials_file }}"
        dest: "/opt/{{ app_name }}/gcp-credentials.json"
        owner: "{{ app_user }}"
        group: "{{ app_user }}"
        mode: "0600"
      when:
        - google_cloud_vision_enabled | default(false)
        - google_cloud_credentials_file is defined
        - google_cloud_credentials_file | length > 0

    - name: Update application configuration
      ansible.builtin.template:
        src: "{{ playbook_dir }}/roles/app/templates/application.properties.j2"
        dest: "/opt/{{ app_name }}/application.properties"
        owner: "{{ app_user }}"
        group: "{{ app_user }}"
        mode: "0600"

    - name: Copy jar to server
      ansible.builtin.copy:
        src: "{{ jar_files.files[0].path }}"
        dest: "/opt/{{ app_name }}/{{ app_name }}.jar"
        owner: "{{ app_user }}"
        group: "{{ app_user }}"
        mode: "0644"

    - name: Start application
      ansible.builtin.systemd:
        name: "{{ app_name }}"
        state: started
        enabled: yes

    - name: Wait for application to start
      ansible.builtin.uri:
        url: "http://localhost:{{ app_port }}/login"
        status_code: 200
      register: result
      until: result.status == 200
      retries: 30
      delay: 5

    - name: Delete default admin user roles
      community.postgresql.postgresql_query:
        db: "{{ db_name }}"
        login_host: localhost
        login_user: "{{ db_user }}"
        login_password: "{{ db_password }}"
        query: "DELETE FROM user_roles WHERE id_user = 'a0eebc99-9c0b-4ef8-bb6d-6bb9bd380a11'"

    - name: Delete default admin user
      community.postgresql.postgresql_query:
        db: "{{ db_name }}"
        login_host: localhost
        login_user: "{{ db_user }}"
        login_password: "{{ db_password }}"
        query: "DELETE FROM users WHERE id = 'a0eebc99-9c0b-4ef8-bb6d-6bb9bd380a11'"

    - name: Create configured admin user
      community.postgresql.postgresql_query:
        db: "{{ db_name }}"
        login_host: localhost
        login_user: "{{ db_user }}"
        login_password: "{{ db_password }}"
        query: |
          INSERT INTO users (id, username, password, full_name, email, active, created_at, updated_at)
          VALUES (
              gen_random_uuid(),
              %(username)s,
              %(password)s,
              %(full_name)s,
              %(email)s,
              TRUE,
              NOW(),
              NOW()
          )
          ON CONFLICT (username) DO UPDATE SET
              password = EXCLUDED.password,
              full_name = EXCLUDED.full_name,
              email = EXCLUDED.email,
              updated_at = NOW()
          RETURNING id
        named_args:
          username: "{{ admin_username }}"
          password: "{{ admin_password_bcrypt }}"
          full_name: "{{ admin_full_name | default('System Administrator') }}"
          email: "{{ admin_email | default('admin@localhost') }}"
      register: admin_user_result

    - name: Assign ADMIN role to configured admin user
      community.postgresql.postgresql_query:
        db: "{{ db_name }}"
        login_host: localhost
        login_user: "{{ db_user }}"
        login_password: "{{ db_password }}"
        query: |
          INSERT INTO user_roles (id, id_user, role, created_at, created_by)
          VALUES (
              gen_random_uuid(),
              %(user_id)s,
              'ADMIN',
              NOW(),
              'ansible'
          )
          ON CONFLICT DO NOTHING
        named_args:
          user_id: "{{ admin_user_result.query_result[0].id }}"
