# Site configuration for {{ app_domain }} (HTTP only)
# Generated by Ansible - Do not edit manually
# Note: This is used for initial cert provisioning or non-SSL deployments

# Upstream for connection pooling
upstream {{ app_name }}_backend {
    server localhost:{{ app_port }};
    keepalive 32;
}

server {
    listen 80;
    listen [::]:80;
    server_name {{ app_domain }};

    # Logging
    access_log /var/log/nginx/{{ app_name }}_access.log main;
    error_log /var/log/nginx/{{ app_name }}_error.log warn;

    # Allow ACME challenge for cert provisioning
    location /.well-known/acme-challenge/ {
        root /var/www/html;
    }

    # Rate limiting for login endpoint
    location = /login {
        limit_req zone=api_limit burst=5 nodelay;
        limit_conn conn_limit 10;

        proxy_pass http://{{ app_name }}_backend;
        include /etc/nginx/snippets/proxy-params.conf;
    }

    # Rate limiting for API endpoints
    location /api/ {
        limit_req zone=api_limit burst={{ nginx_rate_limit_burst }} nodelay;
        limit_conn conn_limit 20;

        proxy_pass http://{{ app_name }}_backend;
        include /etc/nginx/snippets/proxy-params.conf;
    }

    # Static assets caching
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot|webp|avif)$ {
        proxy_pass http://{{ app_name }}_backend;
        include /etc/nginx/snippets/proxy-params.conf;

        expires 7d;
        add_header Cache-Control "public, immutable";
        access_log off;
    }

    # Main application
    location / {
        limit_req zone=api_limit burst={{ nginx_rate_limit_burst }} nodelay;

        proxy_pass http://{{ app_name }}_backend;
        include /etc/nginx/snippets/proxy-params.conf;
    }
}
